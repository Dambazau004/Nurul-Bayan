<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurul Bayan Science Academy Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-green: #065f46;
            --primary-gold: #f59e0b;
            --accent-blue: #3b82f6;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f8fafc;
        }
        .arabic { 
            font-family: 'Amiri', serif; 
        }

        /* --- UI Components --- */
        .sidebar {
            background-color: var(--primary-green);
        }
        .nav-link:hover {
            background-color: #047857;
            border-left-color: var(--primary-gold);
        }
        .btn-primary {
            background-color: var(--primary-green);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #047857;
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Loading Overlay */
        #loading-overlay {
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 9998;
        }

        /* Login Screen Overlay */
        #login-overlay {
            background: linear-gradient(135deg, var(--primary-green) 0%, #10b981 100%);
            z-index: 9999; 
        }

        /* Modal */
        #custom-modal {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 5000;
        }

        /* --- A4 Report Card Styles --- */
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            padding: 10mm 12mm;
            margin: 10mm auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            position: relative;
            border: 4px double var(--primary-green);
            color: black;
            page-break-after: always; /* Critical for Print All */
            break-after: page;
        }
        .report-header {
            border-bottom: 3px solid var(--primary-gold);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .report-table th, .report-table td {
            border: 1px solid #000;
            padding: 6px;
            font-size: 0.85rem;
        }
        .report-table th {
            background-color: #f0fdf4;
            color: var(--primary-green);
            font-weight: bold;
            text-align: center;
        }
        .report-table td.center { text-align: center; }
        
        /* Receipt Paper */
        .receipt-paper {
            width: 80mm;
            min-height: 100mm;
            background: white;
            padding: 5mm;
            margin: 10mm auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-family: 'Courier New', Courier, monospace;
            border: 1px dashed #ccc;
            page-break-after: always;
        }

        /* --- Printing Styles - FIXED --- */
        @media print {
            body, html {
                background: white;
                height: auto !important;
                overflow: visible !important;
            }
            
            /* Hide the web app UI completely */
            #app-container, #login-overlay, #custom-modal, #loading-overlay {
                display: none !important;
            }

            /* Show printable areas */
            #printable-area, #receipt-preview-area {
                display: block !important;
                position: relative !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                visibility: visible !important;
            }
            
            #printable-area * {
                visibility: visible !important;
            }

            /* Reset A4 Paper for Print */
            .a4-paper {
                margin: 0 auto !important;
                box-shadow: none !important;
                border: 2px solid black !important;
                width: 100% !important;
                min-height: 297mm;
                page-break-inside: avoid;
            }

            .receipt-paper {
                width: 100% !important;
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .a4-paper { width: 100%; padding: 5mm; zoom: 0.6; }
            .receipt-paper { width: 100%; }
            
            /* Fix Content Hiding */
            #content-area {
                padding-bottom: 100px; /* Ensure space for scrolling past footer */
            }
            
            /* Sidebar Z-Index fix */
            #sidebar {
                position: fixed;
                height: 100%;
                z-index: 50;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 flex flex-col justify-center items-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-600 mb-4"></div>
        <p class="text-green-800 font-bold animate-pulse">Syncing with Database...</p>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-overlay" class="fixed top-0 left-0 w-full h-full flex justify-center items-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center transform transition-all duration-300 card-shadow">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-green-500">
                <i class="fas fa-school text-4xl text-green-600"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Portal Access</h2>
            <p class="text-gray-500 mb-6 text-sm">Nurul Bayan Admin Login</p>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" class="w-full p-3 mb-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <p id="login-message" class="text-red-500 text-sm mb-4 hidden font-medium">Invalid Credentials. Try Edu / Edu123</p>
                <button type="submit" class="w-full bg-yellow-500 text-gray-900 p-3 rounded-xl font-semibold hover:bg-yellow-600 transition shadow-md">Secure Login</button>
            </form>
        </div>
    </div>

    <!-- CUSTOM MODAL -->
    <div id="custom-modal" class="fixed inset-0 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform transition-all scale-100">
            <div id="modal-header" class="p-4 border-b">
                <h3 id="modal-title" class="font-bold text-lg">Notification</h3>
            </div>
            <div class="p-6">
                <p id="modal-body" class="text-gray-600">Message goes here.</p>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button id="btn-close-modal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium">Close</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar w-64 text-white flex flex-col transition-all duration-300 transform -translate-x-full md:translate-x-0">
            <div class="p-6 text-center border-b border-green-800">
                <div class="w-16 h-16 bg-white rounded-full mx-auto mb-2 flex items-center justify-center text-green-800 text-2xl font-bold">NB</div>
                <h1 class="text-xl font-bold text-yellow-500">NURUL BAYAN</h1>
                <p class="text-xs text-green-200 mt-1 arabic">أكاديمية نور البيان للعلوم</p>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <a id="nav-dashboard" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-chart-line w-6"></i> Dashboard</a>
                <a id="nav-students" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-user-plus w-6"></i> Students</a>
                <a id="nav-subjects" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-book w-6"></i> Subjects</a>
                <a id="nav-marks" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-pencil-alt w-6"></i> Enter Marks</a>
                <a id="nav-reports" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-print w-6"></i> Report Cards</a>
                <a id="nav-finance" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-receipt w-6"></i> Fee Receipts</a>
            </nav>
            <div class="p-4 border-t border-green-800">
                <button id="btn-logout" class="w-full py-2 bg-red-600 rounded-xl text-sm font-semibold hover:bg-red-700 transition">Logout</button>
            </div>
        </aside>
        
        <!-- OVERLAY FOR MOBILE SIDEBAR -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-full relative w-full">
            <!-- HEADER -->
            <header class="bg-white shadow-lg p-4 flex justify-between items-center z-10 sticky top-0">
                <button id="btn-toggle-sidebar" class="text-gray-600 md:hidden focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <h2 class="text-xl font-bold text-gray-700" id="page-title">Dashboard</h2>
                <div class="flex items-center space-x-3">
                    <p class="text-sm font-medium hidden md:block text-gray-500">Admin Staff</p>
                    <div class="w-10 h-10 rounded-full bg-yellow-500 text-gray-900 flex items-center justify-center font-bold shadow-md">A</div>
                </div>
            </header>

            <!-- CONTENT VIEWS -->
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl card-shadow border-b-4 border-yellow-500 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Total Students</p>
                                <h3 class="text-4xl font-extrabold text-primary-green" id="stat-students">0</h3>
                            </div>
                            <i class="fas fa-users text-5xl text-green-100"></i>
                        </div>
                        <div class="bg-white p-6 rounded-2xl card-shadow border-b-4 border-blue-500 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Active Classes</p>
                                <h3 class="text-4xl font-extrabold text-blue-700" id="stat-classes">0</h3>
                            </div>
                            <i class="fas fa-chalkboard-teacher text-5xl text-blue-100"></i>
                        </div>
                        <div class="bg-white p-6 rounded-2xl card-shadow border-b-4 border-red-500 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Taught Subjects</p>
                                <h3 class="text-4xl font-extrabold text-red-700" id="stat-subjects">0</h3>
                            </div>
                            <i class="fas fa-book-open text-5xl text-red-100"></i>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl card-shadow">
                        <h3 class="font-bold text-xl mb-4 text-gray-700 border-b pb-2">Quick Access</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button class="quick-nav p-4 bg-green-50 rounded-xl text-green-800 hover:bg-green-100 transition flex flex-col items-center shadow-md" data-target="students">
                                <i class="fas fa-user-graduate mb-2 text-2xl"></i> New Admission
                            </button>
                            <button class="quick-nav p-4 bg-yellow-50 rounded-xl text-yellow-800 hover:bg-yellow-100 transition flex flex-col items-center shadow-md" data-target="marks">
                                <i class="fas fa-marker mb-2 text-2xl"></i> Input Scores
                            </button>
                            <button class="quick-nav p-4 bg-blue-50 rounded-xl text-blue-800 hover:bg-blue-100 transition flex flex-col items-center shadow-md" data-target="finance">
                                <i class="fas fa-wallet mb-2 text-2xl"></i> Fee Management
                            </button>
                            <button class="quick-nav p-4 bg-red-50 rounded-xl text-red-800 hover:bg-red-100 transition flex flex-col items-center shadow-md" data-target="reports">
                                <i class="fas fa-file-pdf mb-2 text-2xl"></i> Generate Reports
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 2. STUDENTS -->
                <div id="view-students" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">New Student Admission Form</h3>
                        <form id="form-add-student" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="std-name" class="w-full p-3 border border-gray-300 rounded-xl" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Class</label>
                                <select id="std-class" class="w-full p-3 border border-gray-300 rounded-xl" required>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Gender</label>
                                <select id="std-gender" class="w-full p-3 border border-gray-300 rounded-xl">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Photo (Optional)</label>
                                <input type="file" id="std-photo" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="btn-primary w-full px-6 py-3 rounded-xl font-semibold shadow-md">Admit Student</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-2xl card-shadow overflow-hidden">
                        <h3 class="font-bold text-xl mb-4">Registered Students</h3>
                        <div class="flex gap-4 mb-4 items-center flex-wrap">
                             <span class="text-sm font-medium">Filter by Class:</span>
                             <select id="filter-class" class="p-2 border rounded-lg text-sm bg-gray-50">
                                <option value="All">All Classes</option>
                             </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse min-w-[600px]">
                                <thead>
                                    <tr class="bg-gray-100 text-gray-600 text-sm uppercase">
                                        <th class="p-3">Photo</th>
                                        <th class="p-3">Name</th>
                                        <th class="p-3">Class</th>
                                        <th class="p-3">Gender</th>
                                        <th class="p-3">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="student-table-body" class="text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. SUBJECTS -->
                <div id="view-subjects" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">Manage Academic Subjects</h3>
                        <form id="form-add-subject" class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="sub-name" placeholder="Enter Subject Name" class="flex-1 p-3 border rounded-xl" required>
                            <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 font-semibold">Add Subject</button>
                        </form>
                        
                        <div class="mt-8">
                            <h4 class="font-bold text-lg text-gray-700 mb-3">Current Subjects List</h4>
                            <div id="subject-list" class="flex flex-wrap gap-3 p-3 bg-gray-50 rounded-xl border border-gray-200"></div>
                        </div>
                    </div>
                </div>

                <!-- 4. MARKS -->
                <div id="view-marks" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">Input Scores</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <select id="marks-class" class="p-3 border rounded-xl w-full bg-gray-50">
                                <option value="">Select Class</option>
                            </select>
                            <select id="marks-term" class="p-3 border rounded-xl w-full bg-gray-50">
                                <option value="First Term">First Term</option>
                                <option value="Second Term">Second Term</option>
                                <option value="Third Term">Third Term</option>
                            </select>
                            <select id="marks-subject" class="p-3 border rounded-xl w-full bg-gray-50">
                                <option value="">Select Subject</option>
                            </select>
                            <button id="btn-save-marks" class="bg-yellow-500 text-gray-900 p-3 rounded-xl font-semibold hover:bg-yellow-600 transition shadow-md">Save All Scores</button>
                        </div>
                        
                        <div class="overflow-x-auto border rounded-xl">
                            <table class="w-full text-left border-collapse min-w-[600px]">
                                <thead>
                                    <tr class="bg-gray-800 text-white text-sm uppercase">
                                        <th class="p-3 w-1/3">Student Name</th>
                                        <th class="p-3 w-20">C.A (40)</th>
                                        <th class="p-3 w-20">Exam (60)</th>
                                        <th class="p-3 w-20">Total (100)</th>
                                        <th class="p-3 w-20">Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="marks-table-body" class="text-sm"></tbody>
                            </table>
                            <div id="no-marks-msg" class="text-center py-8 text-gray-500">
                                <i class="fas fa-exclamation-circle mr-2"></i> Select Class, Term, and Subject to enter marks.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. REPORTS -->
                <div id="view-reports" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow no-print">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">Report Cards</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <select id="report-class" class="p-3 border rounded-xl bg-gray-50">
                                <option value="">Select Class</option>
                            </select>
                            <select id="report-term" class="p-3 border rounded-xl bg-gray-50">
                                <option value="First Term">First Term</option>
                                <option value="Second Term">Second Term</option>
                                <option value="Third Term">Third Term</option>
                            </select>
                            <div class="flex gap-2">
                                <button id="btn-print-all" class="bg-red-600 text-white px-4 py-3 rounded-xl text-sm flex-1 hover:bg-red-700 font-semibold shadow-md">
                                    <i class="fas fa-print"></i> Print All
                                </button>
                            </div>
                        </div>
                        <div id="report-student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <div class="md:col-span-4 text-center text-gray-500">Select Class and Term to view students.</div>
                        </div>
                    </div>

                    <!-- REPORT CARD PREVIEW / PRINT AREA -->
                    <div id="printable-area" class="mt-8"></div>
                </div>

                <!-- 6. FINANCE -->
                <div id="view-finance" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow no-print">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">Fee Receipts</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <select id="receipt-student" class="p-3 border rounded-xl bg-gray-50 col-span-1 md:col-span-2">
                                <option value="">Select Student</option>
                            </select>
                             <input type="number" id="fee-amount" placeholder="Amount (₦)" class="p-3 border rounded-xl">
                             <input type="text" id="fee-purpose" placeholder="Purpose (e.g. School Fees)" class="p-3 border rounded-xl">
                             <button id="btn-generate-receipt" class="bg-yellow-500 text-gray-900 p-3 rounded-xl font-semibold hover:bg-yellow-600 transition shadow-md col-span-1 md:col-span-1">Generate</button>
                        </div>
                    </div>
                      <!-- Receipt Preview Container -->
                      <div id="receipt-preview-area"></div>
                </div>

            </div>

            <!-- FOOTER -->
            <footer class="bg-gray-800 text-white text-center py-3 text-xs z-10 w-full mt-auto">
                <p>Developed by Abu-Abdurrahman CodeVerge Technology | +2348107907647</p>
            </footer>
        </main>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        // Import Firebase functions from the version requested
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { getFirestore, collection, getDocs, setDoc, doc, addDoc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3nMQMbc_nlQqcKUEsH-puraiUzrXQLY0",
            authDomain: "nurul-bayan-science-academy.firebaseapp.com",
            projectId: "nurul-bayan-science-academy",
            storageBucket: "nurul-bayan-science-academy.firebasestorage.app",
            messagingSenderId: "86444557578",
            appId: "1:86444557578:web:ec17056fa02214e4b126f3",
            measurementId: "G-NQ2Q9RLLSC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const dbFirestore = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);

        // --- GLOBAL VARIABLES & STATE ---
        const CREDENTIALS = { user: 'Edu', pass: 'Edu123' };
        const CLASSES = ['Nursery 1', 'Nursery 2', 'Primary 1', 'Primary 2', 'Primary 3', 'Primary 4', 'Primary 5', 'Primary 6', 'Hafeez', 'Pre-Nursery'];
        
        // Local Cache of Database
        let db = {
            students: [],
            subjects: ['Mathematics', 'English', 'Basic Science', 'Islamic Studies', 'Arabic', 'Hausa', 'Social Studies'],
            marks: {}, 
            fees: []
        };

        // --- HELPER FUNCTIONS FOR GLOBAL ACCESS ---
        // We attach these to window because they are called by inline HTML or constructed HTML strings
        window.deleteStudent = async (id) => {
            if(confirm('Are you sure you want to delete this student record?')) {
                showLoading(true);
                try {
                    await deleteDoc(doc(dbFirestore, "students", id));
                    // Also try delete marks
                    try { await deleteDoc(doc(dbFirestore, "marks", id)); } catch(e){}
                    await syncData();
                    renderStudentList();
                    showModal('Success', 'Student deleted.', 'success');
                } catch(e) {
                    showModal('Error', 'Failed to delete: ' + e.message, 'error');
                }
                showLoading(false);
            }
        };

        window.deleteSubject = async (name) => {
            if(confirm('Delete this subject?')) {
                showLoading(true);
                try {
                    // Update the single subjects doc
                    const newSubjects = db.subjects.filter(s => s !== name);
                    await setDoc(doc(dbFirestore, "settings", "academic"), { subjects: newSubjects });
                    await syncData();
                    renderSubjects();
                    showModal('Success', 'Subject deleted.', 'success');
                } catch(e) {
                    showModal('Error', e.message, 'error');
                }
                showLoading(false);
            }
        };

        window.generateReportCard = (studentId, term) => {
            renderReportCardHTML(studentId, term, false); // false = single mode
        };
        
        window.closeModal = () => {
            document.getElementById('custom-modal').classList.add('hidden');
        };

        // --- CORE FUNCTIONS ---
        
        async function initApp() {
            // Check auth
            if(!sessionStorage.getItem('isLoggedIn')) {
                document.getElementById('login-overlay').classList.remove('hidden');
            } else {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                await connectDB();
            }

            // Event Listeners
            setupEventListeners();
        }

        async function connectDB() {
            showLoading(true);
            try {
                // Ensure anonymous auth for Firestore rules
                await signInAnonymously(auth);
                await syncData();
            } catch (error) {
                console.error("DB Connection Error:", error);
                showModal('Database Error', 'Could not connect to Firebase: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function syncData() {
            // 1. Fetch Students
            const studSnap = await getDocs(collection(dbFirestore, "students"));
            db.students = [];
            studSnap.forEach(doc => {
                db.students.push({ id: doc.id, ...doc.data() });
            });

            // 2. Fetch Subjects (stored in settings/academic or create default)
            try {
                const subDoc = await getDoc(doc(dbFirestore, "settings", "academic"));
                if (subDoc.exists()) {
                    db.subjects = subDoc.data().subjects || [];
                } else {
                    // Initialize if not exists
                    await setDoc(doc(dbFirestore, "settings", "academic"), { subjects: db.subjects });
                }
            } catch (e) { console.log("Subjects init error", e); }

            // 3. Fetch Marks
            const marksSnap = await getDocs(collection(dbFirestore, "marks"));
            db.marks = {};
            marksSnap.forEach(doc => {
                db.marks[doc.id] = doc.data();
            });

            // Refresh UI
            renderDashboard();
            populateDropdowns();
        }

        function setupEventListeners() {
            // Login
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                if (u === CREDENTIALS.user && p === CREDENTIALS.pass) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    await connectDB();
                } else {
                    document.getElementById('login-message').classList.remove('hidden');
                }
            });

            // Navigation
            ['dashboard', 'students', 'subjects', 'marks', 'reports', 'finance'].forEach(view => {
                const btn = document.getElementById('nav-' + view);
                if(btn) btn.addEventListener('click', () => navigate(view));
            });
            
            document.querySelectorAll('.quick-nav').forEach(btn => {
                btn.addEventListener('click', () => navigate(btn.dataset.target));
            });

            // Sidebar Toggle
            document.getElementById('btn-toggle-sidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.remove('hidden');
            });
            document.getElementById('sidebar-overlay').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            });

            // Logout
            document.getElementById('btn-logout').addEventListener('click', () => {
                sessionStorage.removeItem('isLoggedIn');
                location.reload();
            });

            // Forms
            document.getElementById('form-add-student').addEventListener('submit', handleAddStudent);
            document.getElementById('form-add-subject').addEventListener('submit', handleAddSubject);
            document.getElementById('btn-save-marks').addEventListener('click', handleSaveMarks);
            document.getElementById('btn-generate-receipt').addEventListener('click', handleGenerateReceipt);
            document.getElementById('btn-print-all').addEventListener('click', handlePrintAll);
            document.getElementById('btn-close-modal').addEventListener('click', () => document.getElementById('custom-modal').classList.add('hidden'));

            // Filter Change
            document.getElementById('filter-class').addEventListener('change', renderStudentList);
            
            // Marks Dropdowns
            ['marks-class', 'marks-term', 'marks-subject'].forEach(id => {
                document.getElementById(id).addEventListener('change', loadMarksTable);
            });
            // Reports Dropdowns
            ['report-class', 'report-term'].forEach(id => {
                document.getElementById(id).addEventListener('change', loadReportStudents);
            });
        }

        // --- LOGIC FUNCTIONS ---

        function navigate(viewName) {
            ['dashboard', 'students', 'subjects', 'marks', 'reports', 'finance'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
            });
            document.getElementById('view-' + viewName).classList.remove('hidden');
            document.getElementById('page-title').innerText = viewName.charAt(0).toUpperCase() + viewName.slice(1);
            
            // Mobile: close sidebar
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');

            // Clear prints
            document.getElementById('printable-area').innerHTML = '';
            document.getElementById('receipt-preview-area').innerHTML = '';

            if(viewName === 'students') renderStudentList();
        }

        function showLoading(show) {
            const el = document.getElementById('loading-overlay');
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function showModal(title, body, type) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = body;
            const header = document.getElementById('modal-header');
            if(type === 'success') header.className = 'p-4 border-b bg-green-100 text-green-800';
            else if(type === 'error') header.className = 'p-4 border-b bg-red-100 text-red-800';
            else header.className = 'p-4 border-b bg-white';
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        function populateDropdowns() {
            const ids = ['std-class', 'filter-class', 'marks-class', 'report-class'];
            ids.forEach(id => {
                const sel = document.getElementById(id);
                if(!sel) return;
                const currentVal = sel.value;
                sel.innerHTML = id === 'filter-class' ? '<option value="All">All Classes</option>' : '<option value="">Select Class</option>';
                CLASSES.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.innerText = c;
                    sel.appendChild(opt);
                });
                sel.value = currentVal; 
            });

            // Subjects
            const subSel = document.getElementById('marks-subject');
            if(subSel) {
                subSel.innerHTML = '<option value="">Select Subject</option>';
                db.subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.innerText = s;
                    subSel.appendChild(opt);
                });
            }

            // Students for receipt
            const recSel = document.getElementById('receipt-student');
            if(recSel) {
                recSel.innerHTML = '<option value="">Select Student</option>';
                db.students.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.innerText = `${s.name} (${s.class})`;
                    recSel.appendChild(opt);
                });
            }
        }

        function renderDashboard() {
            document.getElementById('stat-students').innerText = db.students.length;
            document.getElementById('stat-classes').innerText = CLASSES.length;
            document.getElementById('stat-subjects').innerText = db.subjects.length;
        }

        // --- STUDENTS ---
        async function handleAddStudent(e) {
            e.preventDefault();
            const name = document.getElementById('std-name').value;
            const cls = document.getElementById('std-class').value;
            const gender = document.getElementById('std-gender').value;
            const fileInput = document.getElementById('std-photo');

            showLoading(true);

            const processSave = async (imgData) => {
                try {
                    const docRef = await addDoc(collection(dbFirestore, "students"), {
                        name, class: cls, gender, photo: imgData || null
                    });
                    // Refresh
                    await syncData();
                    renderStudentList();
                    e.target.reset();
                    showModal('Success', 'Student admitted!', 'success');
                } catch(err) {
                    showModal('Error', err.message, 'error');
                }
                showLoading(false);
            };

            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (re) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 150; 
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        processSave(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = re.target.result;
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                processSave(null);
            }
        }

        function renderStudentList() {
            const filter = document.getElementById('filter-class').value;
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = '';
            
            const filtered = filter === 'All' ? db.students : db.students.filter(s => s.class === filter);
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No students found.</td></tr>';
                return;
            }

            filtered.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="p-3">
                         ${s.photo ? `<img src="${s.photo}" class="w-10 h-10 rounded-full object-cover border">` : '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500"><i class="fas fa-user"></i></div>'}
                    </td>
                    <td class="p-3 font-medium">${s.name}</td>
                    <td class="p-3"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs whitespace-nowrap">${s.class}</span></td>
                    <td class="p-3 text-gray-500">${s.gender}</td>
                    <td class="p-3">
                        <button onclick="deleteStudent('${s.id}')" class="text-red-500 hover:text-red-700 transition"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- SUBJECTS ---
        async function handleAddSubject(e) {
            e.preventDefault();
            const val = document.getElementById('sub-name').value.trim();
            if(val && !db.subjects.includes(val)) {
                showLoading(true);
                try {
                    const newSubs = [...db.subjects, val];
                    await setDoc(doc(dbFirestore, "settings", "academic"), { subjects: newSubs });
                    await syncData();
                    renderSubjects();
                    document.getElementById('sub-name').value = '';
                    showModal('Success', 'Subject added.', 'success');
                } catch(err) {
                    showModal('Error', err.message, 'error');
                }
                showLoading(false);
            }
        }

        function renderSubjects() {
            const div = document.getElementById('subject-list');
            div.innerHTML = '';
            db.subjects.forEach(s => {
                const tag = document.createElement('div');
                tag.className = 'bg-white border px-3 py-1 rounded-full text-sm flex items-center gap-2 shadow-sm';
                tag.innerHTML = `${s} <button onclick="deleteSubject('${s}')" class="text-red-500 hover:text-red-700 ml-1"><i class="fas fa-times"></i></button>`;
                div.appendChild(tag);
            });
        }

        // --- MARKS ---
        // Temp storage for UI editing before saving to DB
        window.tempMarks = {}; 

        function loadMarksTable() {
            const cls = document.getElementById('marks-class').value;
            const term = document.getElementById('marks-term').value;
            const sub = document.getElementById('marks-subject').value;
            const tbody = document.getElementById('marks-table-body');
            const msg = document.getElementById('no-marks-msg');

            if(!cls || !term || !sub) {
                tbody.innerHTML = '';
                msg.classList.remove('hidden');
                return;
            }
            msg.classList.add('hidden');
            tbody.innerHTML = '';
            window.tempMarks = {}; // Reset

            const students = db.students.filter(s => s.class === cls);
            if(students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">No students in this class.</td></tr>';
                return;
            }

            students.forEach(s => {
                // Get existing mark from local DB cache
                let ca = 0, exam = 0;
                if(db.marks[s.id] && db.marks[s.id][term] && db.marks[s.id][term][sub]) {
                    ca = db.marks[s.id][term][sub].ca || 0;
                    exam = db.marks[s.id][term][sub].exam || 0;
                }
                
                // Init temp obj for this student
                window.tempMarks[s.id] = { ca, exam };

                const total = parseInt(ca) + parseInt(exam);
                const grade = getGrade(total);

                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="p-3 font-medium">${s.name}</td>
                    <td class="p-3"><input type="number" min="0" max="40" class="w-16 border rounded p-1" value="${ca}" onchange="updateTempMark('${s.id}', 'ca', this.value)"></td>
                    <td class="p-3"><input type="number" min="0" max="60" class="w-16 border rounded p-1" value="${exam}" onchange="updateTempMark('${s.id}', 'exam', this.value)"></td>
                    <td class="p-3 font-bold text-gray-700" id="total-${s.id}">${total}</td>
                    <td class="p-3"><span id="grade-${s.id}" class="px-2 py-1 rounded text-xs font-bold ${getGradeColor(grade)}">${grade}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Attached to window for inline calls
        window.updateTempMark = (id, type, val) => {
            val = parseInt(val) || 0;
            if(type === 'ca' && val > 40) val = 40;
            if(type === 'exam' && val > 60) val = 60;
            
            if(!window.tempMarks[id]) window.tempMarks[id] = {ca:0, exam:0};
            window.tempMarks[id][type] = val;

            const t = window.tempMarks[id];
            const total = parseInt(t.ca) + parseInt(t.exam);
            document.getElementById(`total-${id}`).innerText = total;
            const grade = getGrade(total);
            const badge = document.getElementById(`grade-${id}`);
            badge.innerText = grade;
            badge.className = `px-2 py-1 rounded text-xs font-bold ${getGradeColor(grade)}`;
        };

        async function handleSaveMarks() {
            const cls = document.getElementById('marks-class').value;
            const term = document.getElementById('marks-term').value;
            const sub = document.getElementById('marks-subject').value;

            if(!cls || !term || !sub) return;

            showLoading(true);
            try {
                // Batch updates using Promise.all
                const updates = [];
                const students = db.students.filter(s => s.class === cls);
                
                for(let s of students) {
                    if(window.tempMarks[s.id]) {
                        const newData = window.tempMarks[s.id];
                        // Get current data for student
                        const currentData = db.marks[s.id] || {};
                        if(!currentData[term]) currentData[term] = {};
                        currentData[term][sub] = newData;

                        updates.push(setDoc(doc(dbFirestore, "marks", s.id), currentData, { merge: true }));
                    }
                }
                
                await Promise.all(updates);
                await syncData();
                showModal('Success', 'Marks saved successfully.', 'success');
            } catch(e) {
                showModal('Error', e.message, 'error');
            }
            showLoading(false);
        }

        // --- REPORTS ---
        function loadReportStudents() {
            const cls = document.getElementById('report-class').value;
            const term = document.getElementById('report-term').value;
            const container = document.getElementById('report-student-list');
            
            if(!cls) {
                container.innerHTML = '<div class="md:col-span-4 text-center text-gray-500">Select Class to view students.</div>';
                return;
            }

            const students = db.students.filter(s => s.class === cls);
            container.innerHTML = '';
            
            students.forEach(s => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl shadow-sm border hover:shadow-md transition cursor-pointer flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-sm">${s.name}</p>
                        <p class="text-xs text-gray-500">ID: ${s.id.substr(-4)}</p>
                    </div>
                    <button onclick="generateReportCard('${s.id}', '${term}')" class="text-blue-600 bg-blue-50 p-2 rounded-lg hover:bg-blue-100"><i class="fas fa-eye"></i></button>
                `;
                container.appendChild(div);
            });
        }

        function calculatePosition(cls, term) {
            const students = db.students.filter(s => s.class === cls);
            let averages = students.map(s => {
                let totalScore = 0;
                let subjectCount = 0;
                if(db.marks[s.id] && db.marks[s.id][term]) {
                    Object.values(db.marks[s.id][term]).forEach(sub => {
                        totalScore += (parseInt(sub.ca||0) + parseInt(sub.exam||0));
                        subjectCount++;
                    });
                }
                return { 
                    id: s.id, 
                    avg: subjectCount > 0 ? (totalScore / subjectCount) : 0
                };
            });
            averages.sort((a, b) => b.avg - a.avg);
            let positions = {};
            averages.forEach((item, index) => {
                positions[item.id] = index + 1;
            });
            return positions;
        }

        function renderReportCardHTML(studentId, term, isPrintAll) {
            const s = db.students.find(x => x.id === studentId);
            if (!s) return;

            const marksData = (db.marks[s.id] && db.marks[s.id][term]) ? db.marks[s.id][term] : {};
            const positions = calculatePosition(s.class, term);
            const position = positions[s.id];
            
            let rowsHtml = '';
            let grandTotal = 0;
            let subjectCount = 0;

            db.subjects.forEach(sub => {
                const score = marksData[sub] || {ca: 0, exam: 0};
                const total = parseInt(score.ca||0) + parseInt(score.exam||0);
                if (marksData[sub]) {
                    grandTotal += total;
                    subjectCount++;
                }
                const grade = getGrade(total);
                rowsHtml += `
                    <tr>
                        <td class="p-1">${sub}</td>
                        <td class="center p-1">${score.ca||'-'}</td>
                        <td class="center p-1">${score.exam||'-'}</td>
                        <td class="center font-bold p-1">${total}</td>
                        <td class="center font-bold p-1 ${grade === 'F' ? 'text-red-600' : 'text-green-800'}">${grade}</td>
                        <td class="center text-xs p-1">${getRemark(grade)}</td>
                    </tr>
                `;
            });

            const avg = subjectCount > 0 ? (grandTotal / subjectCount).toFixed(1) : 0;
            const ordinal = getOrdinal(position);

            const html = `
                <div class="a4-paper">
                    <div class="report-header text-center">
                         <div class="flex justify-between items-center px-4 mb-2">
                            <div class="w-16">
                                <i class="fas fa-book-open text-3xl text-green-700"></i>
                            </div>
                            <div class="flex-1">
                                <h1 class="text-2xl font-bold text-green-800">NURUL BAYAN SCIENCE ACADEMY</h1>
                                <p class="arabic text-lg text-green-600">أكاديمية نور البيان للعلوم</p>
                                <p class="text-[10px] text-gray-500 mt-1">Motto: Knowledge & Character</p>
                            </div>
                            <div class="w-16"></div>
                        </div>
                        <div class="bg-green-700 text-white py-1 font-bold uppercase text-xs rounded-sm">Student Terminal Report Sheet</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm mb-4 border p-2 bg-gray-50 rounded">
                        <div>Name: <b>${s.name}</b></div>
                        <div>Class: <b>${s.class}</b></div>
                        <div>Term: <b>${term}</b></div>
                        <div>Gender: <b>${s.gender}</b></div>
                    </div>

                    <table class="report-table">
                        <thead>
                            <tr>
                                <th class="text-left p-1">Subject</th>
                                <th class="w-12 p-1">CA</th>
                                <th class="w-12 p-1">Exam</th>
                                <th class="w-12 p-1">Tot</th>
                                <th class="w-12 p-1">Grd</th>
                                <th class="w-20 p-1">Rem</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>

                     <div class="grid grid-cols-4 gap-2 mb-6 text-sm border-t pt-2">
                        <div class="bg-gray-100 p-2 text-center rounded">
                            <p class="text-[10px] text-gray-500">Total</p>
                            <p class="font-bold">${grandTotal}</p>
                        </div>
                        <div class="bg-gray-100 p-2 text-center rounded">
                            <p class="text-[10px] text-gray-500">Avg</p>
                            <p class="font-bold">${avg}%</p>
                        </div>
                        <div class="bg-gray-100 p-2 text-center rounded">
                            <p class="text-[10px] text-gray-500">Count</p>
                            <p class="font-bold">${subjectCount}</p>
                        </div>
                         <div class="bg-yellow-100 p-2 text-center rounded border border-yellow-300">
                            <p class="text-[10px] text-gray-600">Position</p>
                            <p class="font-bold text-lg text-yellow-700">${position}<sup>${ordinal}</sup></p>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-2 gap-8 text-center">
                        <div><div class="border-b border-black mb-1 w-3/4 mx-auto"></div><p class="text-[10px] font-bold">Teacher's Sig</p></div>
                        <div><div class="border-b border-black mb-1 w-3/4 mx-auto"></div><p class="text-[10px] font-bold">Principal's Sig</p></div>
                    </div>
                </div>
            `;

            const area = document.getElementById('printable-area');
            if(isPrintAll) {
                area.insertAdjacentHTML('beforeend', html);
            } else {
                area.innerHTML = html;
                window.print();
            }
        }

        async function handlePrintAll() {
            const cls = document.getElementById('report-class').value;
            const term = document.getElementById('report-term').value;
            
            if(!cls) return;
            
            const area = document.getElementById('printable-area');
            area.innerHTML = ''; // Clear previous

            const students = db.students.filter(s => s.class === cls);
            
            // Calculate positions first
            const positions = calculatePosition(cls, term);

            // Loop and append
            students.forEach(s => {
                renderReportCardHTML(s.id, term, true);
            });

            // Wait a moment for DOM update then print
            setTimeout(() => {
                window.print();
            }, 500);
        }

        // --- UTILS ---
        function getGrade(score) {
            if (score >= 70) return 'A';
            if (score >= 60) return 'B';
            if (score >= 50) return 'C';
            if (score >= 45) return 'D';
            if (score >= 40) return 'E';
            return 'F';
        }
        function getGradeColor(grade) {
            if (grade === 'A') return 'bg-green-100 text-green-700';
            if (grade === 'B') return 'bg-blue-100 text-blue-700';
            if (grade === 'C') return 'bg-yellow-100 text-yellow-700';
            if (grade === 'F') return 'bg-red-100 text-red-700';
            return 'bg-gray-100 text-gray-700';
        }
        function getRemark(grade) {
            if (grade === 'A') return 'Ex';
            if (grade === 'B') return 'VG';
            if (grade === 'C') return 'Gd';
            if (grade === 'D') return 'Ps';
            if (grade === 'E') return 'Fr';
            return 'Fl';
        }
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        // --- FINANCE ---
        async function handleGenerateReceipt() {
             const stdId = document.getElementById('receipt-student').value;
            const amount = document.getElementById('fee-amount').value;
            const purpose = document.getElementById('fee-purpose').value;

            if(!stdId || !amount || !purpose) return;

            const s = db.students.find(x => x.id === stdId);
            const date = new Date().toLocaleString();
            const receiptId = 'RCP' + Date.now().toString().substr(-6);

            const html = `
                <div class="receipt-paper">
                    <div class="text-center border-b border-dashed pb-2 mb-2">
                        <h2 class="font-bold text-lg">NURUL BAYAN</h2>
                        <p class="text-xs">Receipt</p>
                    </div>
                    <div class="text-xs space-y-2 mb-4">
                        <div class="flex justify-between"><span>Date:</span> <span>${date.split(',')[0]}</span></div>
                        <div class="flex justify-between"><span>RCP #:</span> <span>${receiptId}</span></div>
                        <div class="flex justify-between"><span>Student:</span> <span>${s.name}</span></div>
                    </div>
                    <div class="border-t border-b border-dashed py-2 my-2">
                        <p class="text-[10px] text-gray-500">Payment For:</p>
                        <p class="text-sm font-bold">${purpose}</p>
                    </div>
                    <div class="flex justify-between font-bold text-lg mt-2">
                        <span>Paid:</span>
                        <span>₦${parseInt(amount).toLocaleString()}</span>
                    </div>
                     <div class="text-center mt-6">
                        <p class="text-[10px]">Manager Sign: ________________</p>
                    </div>
                </div>
            `;
            
            document.getElementById('receipt-preview-area').innerHTML = html;
            window.print();

            // Save to DB
            showLoading(true);
            try {
                await addDoc(collection(dbFirestore, "fees"), {
                    receiptId, studentId: stdId, amount, purpose, date
                });
                document.getElementById('fee-amount').value = '';
                document.getElementById('fee-purpose').value = '';
            } catch(e) { console.error(e); }
            showLoading(false);
        }

        // Init App
        initApp();
    </script>
</body>
</html>

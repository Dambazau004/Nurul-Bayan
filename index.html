<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurul Bayan Science Academy Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Google Fonts: Poppins for modern look, Amiri for Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Define a custom color palette for a unique, premium look */
        :root {
            --primary-green: #065f46; /* Emerald 800 */
            --primary-gold: #f59e0b; /* Amber 500 */
            --accent-blue: #3b82f6;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f8fafc; /* Light Gray Background */
        }
        .arabic { 
            font-family: 'Amiri', serif; 
        }

        /* --- UI Components --- */
        .sidebar {
            background-color: var(--primary-green);
        }
        .nav-link:hover {
            background-color: #047857; /* Slightly lighter green on hover */
            border-left-color: var(--primary-gold);
        }
        .btn-primary {
            background-color: var(--primary-green);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #047857;
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Login Screen Overlay */
        #login-overlay {
            background: linear-gradient(135deg, var(--primary-green) 0%, #10b981 100%);
            z-index: 9999; 
        }

        /* --- A4 Report Card Styles (Designable Unique) --- */
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            padding: 18mm 12mm; /* Reduced padding for more content space */
            margin: 10mm auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            position: relative;
            border: 4px solid var(--primary-green); /* Rich border */
        }
        .report-header {
            border-bottom: 5px double var(--primary-gold);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .report-title {
            color: var(--primary-green);
            text-shadow: 1px 1px 2px #ddd;
        }
        .report-table th {
            background-color: var(--primary-green);
            color: white;
        }
        
        /* --- Printing Styles - CRITICAL --- */
        @media print {
            body * {
                visibility: hidden;
            }
            /* Make both printable areas and their contents visible */
            #printable-area, #printable-area *, 
            #receipt-preview-area, #receipt-preview-area * {
                visibility: visible;
                box-shadow: none !important;
                border-color: black !important; /* Ensure borders print clearly */
            }
            
            /* Global print container settings */
            #printable-area, #receipt-preview-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none !important;
            }

            /* A4 Portrait Setting */
            @page {
                size: A4 portrait;
                margin: 0.5cm;
            }
            .no-print { display: none !important; }
            .a4-paper {
                margin: 0;
                box-shadow: none;
                border: none !important;
                width: 100%;
                min-height: auto;
            }
             /* Ensure receipt layout is tight when printed */
            .receipt-paper {
                /* Override A4 settings for the small receipt print format */
                width: 100mm !important;
                min-height: 140mm !important;
                padding: 5mm !important;
                margin: 0 auto !important;
            }
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .a4-paper { width: 100%; padding: 5mm; }
            .receipt-paper { width: 100%; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-overlay" class="fixed top-0 left-0 w-full h-full flex justify-center items-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center transform transition-all duration-300 card-shadow">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-green-500">
                <i class="fas fa-lock text-4xl text-green-600"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Portal Access</h2>
            <p class="text-gray-500 mb-6 text-sm">Nurul Bayan Admin Login</p>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" placeholder="Username" class="w-full p-3 mb-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <input type="password" id="password" placeholder="Password" class="w-full p-3 mb-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <p id="login-message" class="text-red-500 text-sm mb-4 hidden font-medium">Invalid Credentials. Try Edu / Edu123</p>
                <button type="submit" class="w-full bg-yellow-500 text-gray-900 p-3 rounded-xl font-semibold hover:bg-yellow-600 transition shadow-md">Secure Login</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="sidebar w-64 text-white flex flex-col transition-all duration-300 absolute md:relative z-20 h-full transform -translate-x-full md:translate-x-0">
            <div class="p-6 text-center border-b border-green-800">
                <h1 class="text-2xl font-bold text-yellow-500">NURUL BAYAN</h1>
                <p class="text-sm text-green-200 mt-1 arabic">أكاديمية نور البيان للعلوم</p>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <a onclick="navigate('dashboard')" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-chart-line w-6"></i> Dashboard</a>
                <a onclick="navigate('students')" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-user-plus w-6"></i> Students Admission</a>
                <a onclick="navigate('subjects')" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-book w-6"></i> Manage Subjects</a>
                <a onclick="navigate('marks')" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-pencil-alt w-6"></i> Enter Marks</a>
                <a onclick="navigate('reports')" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-print w-6"></i> Report Cards</a>
                <a onclick="navigate('finance')" class="nav-link cursor-pointer block py-3 px-6 border-l-4 border-transparent transition"><i class="fas fa-receipt w-6"></i> Fee Receipts</a>
            </nav>
            <div class="p-4 border-t border-green-800">
                <button onclick="logout()" class="w-full py-2 bg-red-600 rounded-xl text-sm font-semibold hover:bg-red-700 transition">Logout</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col h-full relative">
            <!-- HEADER -->
            <header class="bg-white shadow-lg p-4 flex justify-between items-center z-10">
                <button onclick="toggleSidebar()" class="text-gray-600 md:hidden focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
                <h2 class="text-xl font-bold text-gray-700" id="page-title">Dashboard</h2>
                <div class="flex items-center space-x-3">
                    <p class="text-sm font-medium hidden md:block text-gray-500">Welcome, Staff</p>
                    <div class="w-10 h-10 rounded-full bg-yellow-500 text-gray-900 flex items-center justify-center font-bold shadow-md">A</div>
                </div>
            </header>

            <!-- CONTENT VIEWS -->
            <div id="content-area" class="flex-1 overflow-auto p-4 md:p-8 bg-gray-50">
                
                <!-- 1. DASHBOARD -->
                <div id="view-dashboard" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Card 1: Students -->
                        <div class="bg-white p-6 rounded-2xl card-shadow border-b-4 border-yellow-500 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Total Students</p>
                                <h3 class="text-4xl font-extrabold text-primary-green" id="stat-students">0</h3>
                            </div>
                            <i class="fas fa-users text-5xl text-green-100"></i>
                        </div>
                        <!-- Card 2: Classes -->
                        <div class="bg-white p-6 rounded-2xl card-shadow border-b-4 border-blue-500 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Active Classes</p>
                                <h3 class="text-4xl font-extrabold text-blue-700" id="stat-classes">0</h3>
                            </div>
                            <i class="fas fa-chalkboard-teacher text-5xl text-blue-100"></i>
                        </div>
                        <!-- Card 3: Subjects -->
                        <div class="bg-white p-6 rounded-2xl card-shadow border-b-4 border-red-500 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Taught Subjects</p>
                                <h3 class="text-4xl font-extrabold text-red-700" id="stat-subjects">0</h3>
                            </div>
                            <i class="fas fa-book-open text-5xl text-red-100"></i>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl card-shadow">
                        <h3 class="font-bold text-xl mb-4 text-gray-700 border-b pb-2">Quick Access</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="navigate('students')" class="p-4 bg-green-50 rounded-xl text-green-800 hover:bg-green-100 transition flex flex-col items-center shadow-md">
                                <i class="fas fa-user-graduate mb-2 text-2xl"></i> New Admission
                            </button>
                            <button onclick="navigate('marks')" class="p-4 bg-yellow-50 rounded-xl text-yellow-800 hover:bg-yellow-100 transition flex flex-col items-center shadow-md">
                                <i class="fas fa-marker mb-2 text-2xl"></i> Input Scores
                            </button>
                            <button onclick="navigate('finance')" class="p-4 bg-blue-50 rounded-xl text-blue-800 hover:bg-blue-100 transition flex flex-col items-center shadow-md">
                                <i class="fas fa-wallet mb-2 text-2xl"></i> Fee Management
                            </button>
                            <button onclick="navigate('reports')" class="p-4 bg-red-50 rounded-xl text-red-800 hover:bg-red-100 transition flex flex-col items-center shadow-md">
                                <i class="fas fa-file-pdf mb-2 text-2xl"></i> Generate Reports
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 2. STUDENTS -->
                <div id="view-students" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">New Student Admission Form</h3>
                        <form onsubmit="addStudent(event)" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="std-name" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Class</label>
                                <select id="std-class" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500" required>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Gender</label>
                                <select id="std-gender" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Photo (Optional - JPEG/PNG)</label>
                                <input type="file" id="std-photo" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                                <p class="text-xs text-orange-500 mt-1">Image will be compressed for storage.</p>
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="btn-primary w-full px-6 py-3 rounded-xl font-semibold shadow-md">Admit Student</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-2xl card-shadow overflow-x-auto">
                        <h3 class="font-bold text-xl mb-4">Registered Students</h3>
                        <div class="flex gap-4 mb-4 items-center">
                             <span class="text-sm font-medium">Filter by Class:</span>
                             <select id="filter-class" onchange="renderStudentList()" class="p-2 border rounded-lg text-sm bg-gray-50">
                                <option value="All">All Classes</option>
                             </select>
                        </div>
                        <table class="w-full text-left border-collapse min-w-[600px]">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 text-sm uppercase">
                                    <th class="p-3">Name</th>
                                    <th class="p-3">Class</th>
                                    <th class="p-3">Gender</th>
                                    <th class="p-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="student-table-body" class="text-sm">
                                <!-- Rows populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3. SUBJECTS -->
                <div id="view-subjects" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">Manage Academic Subjects</h3>
                        <form onsubmit="addSubject(event)" class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="sub-name" placeholder="Enter Subject Name (e.g., General Mathematics)" class="flex-1 p-3 border rounded-xl focus:ring-green-500 focus:border-green-500" required>
                            <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 font-semibold">Add Subject</button>
                        </form>
                        
                        <div class="mt-8">
                            <h4 class="font-bold text-lg text-gray-700 mb-3">Current Subjects List</h4>
                            <div id="subject-list" class="flex flex-wrap gap-3 p-3 bg-gray-50 rounded-xl border border-gray-200">
                                <!-- Tags populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. MARKS -->
                <div id="view-marks" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">Input Continuous Assessment (C.A) & Exam Scores</h3>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <select id="marks-class" class="p-3 border rounded-xl w-full bg-gray-50" onchange="loadMarksTable()">
                                <option value="">Select Class</option>
                            </select>
                            <select id="marks-term" class="p-3 border rounded-xl w-full bg-gray-50" onchange="loadMarksTable()">
                                <option value="First Term">First Term</option>
                                <option value="Second Term">Second Term</option>
                                <option value="Third Term">Third Term</option>
                            </select>
                            <select id="marks-subject" class="p-3 border rounded-xl w-full bg-gray-50" onchange="loadMarksTable()">
                                <option value="">Select Subject</option>
                            </select>
                            <button onclick="saveAllMarks()" class="bg-yellow-500 text-gray-900 p-3 rounded-xl font-semibold hover:bg-yellow-600 transition shadow-md">Save All Scores</button>
                        </div>
                        
                        <div class="overflow-x-auto border rounded-xl">
                            <table class="w-full text-left border-collapse min-w-[600px]">
                                <thead>
                                    <tr class="bg-gray-800 text-white text-sm uppercase">
                                        <th class="p-3 w-1/3">Student Name</th>
                                        <th class="p-3 w-20">C.A (40)</th>
                                        <th class="p-3 w-20">Exam (60)</th>
                                        <th class="p-3 w-20">Total (100)</th>
                                        <th class="p-3 w-20">Grade</th>
                                    </tr>
                                </thead>
                                <tbody id="marks-table-body" class="text-sm">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                            <div id="no-marks-msg" class="text-center py-8 text-gray-500 hidden">
                                <i class="fas fa-exclamation-circle mr-2"></i> Select Class, Term, and Subject above to start entering marks.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. REPORTS -->
                <div id="view-reports" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow no-print">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">Report Card Generation & History</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <select id="report-class" class="p-3 border rounded-xl bg-gray-50" onchange="loadReportStudents()">
                                <option value="">Select Class</option>
                            </select>
                            <select id="report-term" class="p-3 border rounded-xl bg-gray-50" onchange="loadReportStudents()">
                                <option value="First Term">First Term</option>
                                <option value="Second Term">Second Term</option>
                                <option value="Third Term">Third Term</option>
                            </select>
                            <div class="flex gap-2">
                                <button onclick="downloadClassPerformance()" class="bg-green-600 text-white px-4 py-3 rounded-xl text-sm flex-1 hover:bg-green-700 font-semibold shadow-md">
                                    <i class="fas fa-file-csv"></i> Download Class Data (Landscape)
                                </button>
                                <button onclick="reprintAllReports()" class="bg-red-600 text-white px-4 py-3 rounded-xl text-sm flex-1 hover:bg-red-700 font-semibold shadow-md">
                                    <i class="fas fa-file-alt"></i> Print All
                                </button>
                            </div>
                        </div>
                        <div id="report-student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <div class="md:col-span-4 text-center text-gray-500">
                                <i class="fas fa-arrow-up mr-1"></i> Select Class and Term to view student list for reports.
                            </div>
                            <!-- Student cards populated by JS -->
                        </div>
                    </div>

                    <!-- REPORT CARD PREVIEW / PRINT AREA -->
                    <div id="printable-area" class="mt-8">
                        <!-- Dynamic Content Inserted Here -->
                    </div>
                </div>

                <!-- 6. FINANCE -->
                <div id="view-finance" class="hidden space-y-8">
                    <div class="bg-white p-6 rounded-2xl card-shadow no-print">
                        <h3 class="font-bold text-xl mb-4 text-primary-green border-b pb-2">Generate Fee Receipts</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <select id="receipt-student" class="p-3 border rounded-xl bg-gray-50 col-span-1 md:col-span-2">
                                <option value="">Select Student</option>
                            </select>
                             <input type="number" id="fee-amount" placeholder="Amount (₦)" class="p-3 border rounded-xl">
                             <input type="text" id="fee-purpose" placeholder="Purpose (e.g. School Fees)" class="p-3 border rounded-xl">
                             <button onclick="generateReceipt()" class="bg-yellow-500 text-gray-900 p-3 rounded-xl font-semibold hover:bg-yellow-600 transition shadow-md col-span-1 md:col-span-1">Generate & Print Receipt</button>
                        </div>
                    </div>
                     <!-- Receipt Preview Container -->
                     <div id="receipt-preview-area"></div>
                </div>

            </div>

            <!-- FOOTER -->
            <footer class="bg-gray-800 text-white text-center py-3 text-xs z-10">
                <p>Developed by Abu-Abdurrahman CodeVerge Technology | +2348107907647</p>
            </footer>
        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA & CONFIG ---
        const CREDENTIALS = { user: 'Edu', pass: 'Edu123' };
        const CLASSES = ['Nursery 1', 'Nursery 2', 'Primary 1', 'Primary 2', 'Primary 3', 'Primary 4', 'Primary 5', 'Primary 6', 'Hafeez', 'Pre-Nursery'];
        
        let db = {
            students: [],
            subjects: ['Mathematics', 'English', 'Basic Science', 'Islamic Studies', 'Arabic', 'Hausa', 'Social Studies'],
            marks: {},
            fees: []
        };

        // --- INIT & UTILS ---
        window.onload = function() {
            loadData();
            populateDropdowns();
            renderDashboard();
            renderSubjects();
            
            // Initial check for login state
            if(sessionStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
            }
        };

        function saveData() {
            localStorage.setItem('nurulBayanData', JSON.stringify(db));
            renderDashboard();
        }

        function loadData() {
            const stored = localStorage.getItem('nurulBayanData');
            if (stored) {
                db = JSON.parse(stored);
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        }

        function navigate(viewName) {
            // Hide all views
            ['dashboard', 'students', 'subjects', 'marks', 'reports', 'finance'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
            });
            // Show selected
            document.getElementById('view-' + viewName).classList.remove('hidden');
            document.getElementById('page-title').innerText = viewName.replace(/-/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            
            // Close sidebar on mobile
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            }

            // Clear printable areas when navigating away from reports/finance
            document.getElementById('printable-area').innerHTML = '';
            document.getElementById('receipt-preview-area').innerHTML = '';


            // Refresh specific data
            if(viewName === 'students') renderStudentList();
        }

        // --- AUTH ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const msg = document.getElementById('login-message');

            if (u === CREDENTIALS.user && p === CREDENTIALS.pass) {
                msg.classList.add('hidden');
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                sessionStorage.setItem('isLoggedIn', 'true');
            } else {
                msg.classList.remove('hidden');
            }
        }

        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            document.getElementById('stat-students').innerText = db.students.length;
            document.getElementById('stat-classes').innerText = CLASSES.length;
            document.getElementById('stat-subjects').innerText = db.subjects.length;
        }

        function populateDropdowns() {
            const classDropdowns = ['std-class', 'filter-class', 'marks-class', 'report-class'];
            classDropdowns.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                
                // Keep first option if it's a filter
                if(id === 'filter-class') sel.innerHTML = '<option value="All">All Classes</option>';
                else if(id !== 'std-class') sel.innerHTML = '<option value="">Select Class</option>';
                else sel.innerHTML = ''; // Clear for student add form

                CLASSES.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.innerText = c;
                    sel.appendChild(opt);
                });
            });

            // Subjects
            const subSel = document.getElementById('marks-subject');
            if(subSel) {
                subSel.innerHTML = '<option value="">Select Subject</option>';
                db.subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.innerText = s;
                    subSel.appendChild(opt);
                });
            }
        }

        // --- STUDENTS ---
        function addStudent(e) {
            e.preventDefault();
            const name = document.getElementById('std-name').value;
            const cls = document.getElementById('std-class').value;
            const gender = document.getElementById('std-gender').value;
            const fileInput = document.getElementById('std-photo');
            
            const saveStudent = (imgData) => {
                const newStudent = {
                    id: Date.now().toString(),
                    name,
                    class: cls,
                    gender,
                    photo: imgData || null
                };
                db.students.push(newStudent);
                saveData();
                renderStudentList();
                e.target.reset();
                showModal('Student Added Successfully!', 'The new student has been registered and assigned an internal ID.', 'success');
            };

            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(readerEvent) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 150; 
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        saveStudent(canvas.toDataURL('image/jpeg', 0.7));
                    }
                    img.src = readerEvent.target.result;
                }
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                saveStudent(null);
            }
        }

        function renderStudentList() {
            const tbody = document.getElementById('student-table-body');
            const filter = document.getElementById('filter-class').value;
            tbody.innerHTML = '';
            
            const list = filter === 'All' ? db.students : db.students.filter(s => s.class === filter);
            
            list.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-yellow-50 transition';
                tr.innerHTML = `
                    <td class="p-3 flex items-center gap-3">
                        <img src="${s.photo || 'https://placehold.co/40x40/f1f1f1/888?text=S'}" class="w-10 h-10 rounded-full object-cover border border-gray-300 bg-gray-100">
                        <span class="font-medium">${s.name}</span>
                    </td>
                    <td class="p-3">${s.class}</td>
                    <td class="p-3">${s.gender}</td>
                    <td class="p-3">
                        <button onclick="confirmAction('deleteStudent', '${s.id}', 'Delete ${s.name}?', 'Are you sure you want to delete this student record permanently?')" class="text-red-500 hover:text-red-700 transition p-1 rounded-full hover:bg-red-50"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Also update receipt dropdown
            const rSel = document.getElementById('receipt-student');
            if(rSel) {
                rSel.innerHTML = '<option value="">Select Student</option>';
                db.students.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.innerText = `${s.name} (${s.class})`;
                    rSel.appendChild(opt);
                });
            }
        }
        
        function deleteStudent(id) {
            db.students = db.students.filter(s => s.id !== id);
            saveData();
            renderStudentList();
            showModal('Deletion Successful', 'Student record has been removed.', 'info');
        }

        // --- SUBJECTS ---
        function addSubject(e) {
            e.preventDefault();
            const name = document.getElementById('sub-name').value.trim();
            if(!name) return;
            if(!db.subjects.includes(name)) {
                db.subjects.push(name);
                saveData();
                renderSubjects();
                populateDropdowns(); 
                document.getElementById('sub-name').value = '';
                showModal('Subject Added', `${name} has been added to the subject list.`, 'success');
            } else {
                showModal('Subject Exists', `${name} is already in the list.`, 'warning');
            }
        }

        function renderSubjects() {
            const div = document.getElementById('subject-list');
            div.innerHTML = '';
            db.subjects.forEach(s => {
                const tag = document.createElement('span');
                tag.className = 'px-4 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium flex items-center gap-2 shadow-sm';
                tag.innerHTML = `${s} <i class="fas fa-times cursor-pointer text-gray-500 hover:text-red-500 transition" onclick="confirmAction('removeSubject', '${s}', 'Remove Subject?', 'Are you sure you want to remove ${s}? Mark data for this subject will remain until cleared.')"></i>`;
                div.appendChild(tag);
            });
        }
        
        function removeSubject(name) {
            db.subjects = db.subjects.filter(s => s !== name);
            saveData();
            renderSubjects();
            populateDropdowns();
            showModal('Subject Removed', `${name} has been removed.`, 'info');
        }

        // --- MARKS ---
        let tempMarks = {};
        
        function loadMarksTable() {
            const cls = document.getElementById('marks-class').value;
            const term = document.getElementById('marks-term').value;
            const sub = document.getElementById('marks-subject').value;
            const tbody = document.getElementById('marks-table-body');
            const msg = document.getElementById('no-marks-msg');

            if (!cls || !term || !sub) {
                tbody.innerHTML = '';
                msg.classList.remove('hidden');
                return;
            }
            msg.classList.add('hidden');
            tbody.innerHTML = '';

            const students = db.students.filter(s => s.class === cls);
            tempMarks = {}; // Clear temporary cache

            students.forEach(s => {
                const key = `${s.id}_${term}_${sub}`;
                const data = db.marks[key] || { ca: '', exam: '' };
                
                const ca = Number(data.ca) || 0;
                const ex = Number(data.exam) || 0;
                const total = ca + ex;
                const { grade, color } = getGradeDetails(total);

                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                // We use an empty function here, as the input fields handle the updateMark call
                tr.innerHTML = `
                    <td class="p-3">${s.name}</td>
                    <td class="p-3"><input type="number" max="40" min="0" data-student-id="${s.id}" data-type="ca" class="marks-input w-20 p-2 border rounded text-center focus:border-yellow-500" value="${data.ca}" oninput="updateMark(this, '${s.id}', 'ca')"></td>
                    <td class="p-3"><input type="number" max="60" min="0" data-student-id="${s.id}" data-type="exam" class="marks-input w-20 p-2 border rounded text-center focus:border-yellow-500" value="${data.exam}" oninput="updateMark(this, '${s.id}', 'exam')"></td>
                    <td class="p-3 font-bold text-gray-600 total-score" data-id="${s.id}">${total}</td>
                    <td class="p-3 font-bold ${color} grade-display" data-id="${s.id}">${grade}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateMark(inputElement, studentId, type) {
            let value = parseInt(inputElement.value) || 0;
            const max = type === 'ca' ? 40 : 60;
            
            if (value > max) {
                value = max;
                inputElement.value = max;
            } else if (value < 0) {
                 value = 0;
                 inputElement.value = 0;
            }
            
            const cls = document.getElementById('marks-class').value;
            const term = document.getElementById('marks-term').value;
            const sub = document.getElementById('marks-subject').value;
            const key = `${studentId}_${term}_${sub}`;
            
            if (!tempMarks[key]) tempMarks[key] = db.marks[key] ? {...db.marks[key]} : { ca: '', exam: '' };
            tempMarks[key][type] = value.toString();

            // Live update total and grade
            const ca = type === 'ca' ? value : (parseInt(tempMarks[key]['ca']) || 0);
            const ex = type === 'exam' ? value : (parseInt(tempMarks[key]['exam']) || 0);
            const total = ca + ex;
            const { grade, color } = getGradeDetails(total);

            document.querySelector(`.total-score[data-id="${studentId}"]`).innerText = total;
            const gradeEl = document.querySelector(`.grade-display[data-id="${studentId}"]`);
            gradeEl.innerText = grade;
            gradeEl.className = `p-3 font-bold ${color} grade-display`;
        }
        
        function getGradeDetails(total) {
            let grade, color;
            if (total >= 70) { grade = 'A'; color = 'text-green-600'; }
            else if (total >= 60) { grade = 'B'; color = 'text-blue-600'; }
            else if (total >= 50) { grade = 'C'; color = 'text-yellow-600'; }
            else if (total >= 40) { grade = 'D'; color = 'text-orange-600'; }
            else { grade = 'F'; color = 'text-red-600'; }
            return { grade, color };
        }

        function saveAllMarks() {
            Object.assign(db.marks, tempMarks);
            saveData();
            tempMarks = {};
            loadMarksTable();
            showModal('Marks Saved', 'All changes have been successfully saved to Local Storage.', 'success');
        }

        // --- REPORTS ---
        function loadReportStudents() {
            const cls = document.getElementById('report-class').value;
            const term = document.getElementById('report-term').value;
            const div = document.getElementById('report-student-list');
            div.innerHTML = '';
            
            if(!cls || !term) {
                div.innerHTML = '<div class="md:col-span-4 text-center text-gray-500"><i class="fas fa-arrow-up mr-1"></i> Select Class and Term to view student list for reports.</div>';
                return;
            }

            const students = db.students.filter(s => s.class === cls);
            
            students.forEach(s => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-xl border border-gray-200 flex flex-col justify-between items-start shadow-sm hover:shadow-lg transition';
                card.innerHTML = `
                    <span class="font-bold text-gray-700 mb-2">${s.name}</span>
                    <button onclick="generateReportCard('${s.id}')" class="w-full bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-blue-600 transition">
                        <i class="fas fa-file-pdf mr-1"></i> View/Print Card
                    </button>
                `;
                div.appendChild(card);
            });
        }

        function calculateResults(studentId, cls, term) {
            let totalScore = 0;
            let count = 0;
            let results = [];
            let totalPossibleScore = 0;

            db.subjects.forEach(sub => {
                const key = `${studentId}_${term}_${sub}`;
                const m = db.marks[key];
                
                if (m && (m.ca !== '' || m.exam !== '')) {
                    const ca = Number(m.ca) || 0;
                    const ex = Number(m.exam) || 0;
                    const tot = ca + ex;
                    totalScore += tot;
                    count++;
                    totalPossibleScore += 100;
                    
                    let grade, remark;
                    if (tot >= 70) { grade = 'A'; remark = 'Excellent performance'; }
                    else if (tot >= 60) { grade = 'B'; remark = 'Very Good result'; }
                    else if (tot >= 50) { grade = 'C'; remark = 'Satisfactory achievement'; }
                    else if (tot >= 40) { grade = 'D'; remark = 'Needs more effort'; }
                    else { grade = 'F'; remark = 'Poor, serious attention needed'; }

                    results.push({ subject: sub, ca, exam: ex, total: tot, grade, remark });
                }
            });

            const average = count > 0 ? (totalScore / count).toFixed(2) : 0;
            return { results, totalScore, average, count, totalPossibleScore };
        }

        function getPosition(studentId, cls, term) {
            const students = db.students.filter(s => s.class === cls);
            
            const scores = students.map(s => {
                const res = calculateResults(s.id, cls, term);
                // Position logic is based on Average score
                return { id: s.id, avg: parseFloat(res.average) };
            });
            // Sort descending
            scores.sort((a, b) => b.avg - a.avg);
            // Find index and rank
            const index = scores.findIndex(x => x.id === studentId);
            const rank = index + 1;
            
            // Custom Position rule (100-90 = 1st) - This interpretation is unusual for ranking, 
            // but if required: If average >= 90, 1st position. 
            // If we assume a simplified ranking based on the top percentage bracket:
            if (parseFloat(scores.find(x => x.id === studentId)?.avg) >= 90) return "1st (Top Honours)";

            const j = rank % 10, k = rank % 100;
            if (j == 1 && k != 11) return rank + "st";
            if (j == 2 && k != 12) return rank + "nd";
            if (j == 3 && k != 13) return rank + "rd";
            return rank + "th";
        }

        function generateReportCard(studentId) {
            const cls = document.getElementById('report-class').value;
            const term = document.getElementById('report-term').value;
            const student = db.students.find(s => s.id === studentId);
            const { results, totalScore, average, count } = calculateResults(studentId, cls, term);
            const position = getPosition(studentId, cls, term);
            
            if (count === 0) return showModal('No Marks Recorded', 'There are no marks saved for this student in the selected class and term.', 'warning');

            // CLEAR RECEIPT AREA (CRITICAL)
            document.getElementById('receipt-preview-area').innerHTML = '';
            
            const printable = document.getElementById('printable-area');
            
            let rowsHtml = results.map(r => `
                <tr class="border-b border-gray-300">
                    <td class="p-2 border-r border-gray-300 text-left font-medium">${r.subject}</td>
                    <td class="p-2 border-r border-gray-300 text-center">${r.ca}</td>
                    <td class="p-2 border-r border-gray-300 text-center">${r.exam}</td>
                    <td class="p-2 border-r border-gray-300 text-center font-bold">${r.total}</td>
                    <td class="p-2 border-r border-gray-300 text-center">${r.grade}</td>
                    <td class="p-2 text-left italic text-xs">${r.remark}</td>
                </tr>
            `).join('');

            // Head Teacher Remark Logic
            let headRemark = "Work harder next term, your potential is higher.";
            if (average >= 80) headRemark = "Outstanding Academic Achievement! Continue with the excellent work.";
            else if (average >= 60) headRemark = "Very good effort shown. Focus on improving weaker areas next term.";
            else if (average >= 50) headRemark = "Satisfactory effort. A concentrated focus is needed for better results.";

            printable.innerHTML = `
                <div class="a4-paper">
                    <!-- Header -->
                    <div class="report-header flex items-center justify-between">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center border-2 border-primary-green">
                            <i class="fas fa-certificate text-4xl text-primary-green"></i>
                        </div>
                        <div class="text-center flex-1 px-4">
                            <h1 class="report-title text-3xl font-extrabold uppercase tracking-widest">Nurul Bayan Science Academy</h1>
                            <h2 class="text-xl font-bold text-primary-green arabic mt-1">أكاديمية نور البيان للعلوم</h2>
                            <p class="text-xs font-semibold mt-1 text-gray-700">Opposite Aforestation Janbulo Kano | Contact: +234-8119723517</p>
                            <p class="text-sm italic text-yellow-700 font-bold mt-1">Motto: Knowledge is the Root of Success</p>
                        </div>
                        <div class="w-20 text-center">
                            ${student.photo ? `<img src="${student.photo}" class="w-20 h-20 object-cover border-2 border-primary-green p-0.5 rounded-lg shadow-md">` : '<div class="w-20 h-20 bg-gray-200 flex items-center justify-center text-xs text-gray-500 rounded-lg">Student Photo</div>'}
                        </div>
                    </div>

                    <!-- Report Title Block -->
                    <div class="text-center py-2 mb-4 bg-green-50 rounded-lg border border-green-200">
                        <h3 class="text-xl font-bold text-primary-green">${term} REPORT CARD</h3>
                        <p class="text-sm text-gray-600">ACADEMIC SESSION: 2024/2025</p>
                    </div>

                    <!-- Student Info -->
                    <div class="mb-6 grid grid-cols-2 gap-4 text-sm bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <p><span class="font-bold text-primary-green">Student Name:</span> ${student.name}</p>
                        <p><span class="font-bold text-primary-green">Class:</span> ${cls}</p>
                        <p><span class="font-bold text-primary-green">Gender:</span> ${student.gender}</p>
                        <p><span class="font-bold text-primary-green">Total Subjects:</span> ${count}</p>
                        <p class="col-span-2"><span class="font-bold text-primary-green">Overall Average:</span> <span class="text-lg font-extrabold text-blue-700">${average}%</span></p>
                    </div>

                    <!-- Academic Performance Table -->
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-gray-700 mb-2 border-b-2 border-gray-300 pb-1">Academic Performance</h4>
                        <table class="w-full report-table text-xs border border-gray-400">
                            <thead>
                                <tr class="text-white uppercase font-semibold">
                                    <th class="p-2 border-r border-green-600 text-left w-2/5">Subject</th>
                                    <th class="p-2 border-r border-green-600 w-12">C.A (40)</th>
                                    <th class="p-2 border-r border-green-600 w-12">Exam (60)</th>
                                    <th class="p-2 border-r border-green-600 w-12">Total (100)</th>
                                    <th class="p-2 border-r border-green-600 w-12">Grade</th>
                                    <th class="p-2">Remark</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Summary & QR -->
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-2/3 pr-4">
                            <h4 class="text-lg font-bold text-gray-700 mb-2 border-b-2 border-gray-300 pb-1">Result Summary & Remarks</h4>
                            <table class="w-full text-sm border border-gray-400 mb-4">
                                <tr><td class="p-2 font-bold border-r border-gray-300">Total Score</td><td class="p-2">${totalScore}</td></tr>
                                <tr><td class="p-2 font-bold border-r border-gray-300">Class Position</td><td class="p-2 font-extrabold text-xl text-red-600">${position}</td></tr>
                            </table>
                            
                            <p class="text-sm mb-4"><span class="font-bold text-primary-green">Head Teacher's Comment:</span> ${headRemark}</p>
                            
                            <div class="flex justify-between text-sm mt-6">
                                <div><div class="border-b border-gray-400 w-40 mb-1"></div><p>Parent's Signature</p></div>
                                <div><div class="border-b border-gray-400 w-40 mb-1"></div><p>Head Teacher's Signature</p></div>
                            </div>
                        </div>
                        
                        <!-- QR Code Section -->
                        <div class="w-1/3 flex flex-col items-center justify-center p-3 border-2 border-primary-green rounded-xl bg-green-50">
                            <h5 class="font-bold text-xs mb-2">Verification Code</h5>
                            <div id="qrcode-${studentId}" class="mb-2"></div>
                            <span class="text-[10px] font-mono text-gray-600">Scan QR to verify document integrity</span>
                        </div>
                    </div>
                    
                    <!-- Grading Key -->
                    <div class="text-[11px] text-gray-600 border-t pt-2 flex justify-between">
                         <span class="font-bold">GRADING KEY:</span>
                         <span>70-100 (A: Excellent)</span>
                         <span>60-69 (B: Very Good)</span>
                         <span>50-59 (C: Credit)</span>
                         <span>40-49 (D: Pass)</span>
                         <span>0-39 (F: Fail)</span>
                    </div>

                    <!-- Footer -->
                    <div class="absolute bottom-1 left-0 w-full text-center text-[10px] text-gray-400">
                        Generated by Nurul Bayan Portal | Developed by Abu-Abdurrahman CodeVerge Technology | +2348107907647
                    </div>
                </div>
            `;
            
            // Generate QR Code
            setTimeout(() => {
                const qrDiv = document.getElementById(`qrcode-${studentId}`);
                if (qrDiv) {
                    qrDiv.innerHTML = ''; // Clear existing QR
                    new QRCode(qrDiv, {
                        text: `NURUL BAYAN ACADEMY\nStd: ${student.name}\nClass: ${cls}\nTerm Avg: ${average}%\nPos: ${position}`,
                        width: 90,
                        height: 90,
                        colorDark: "#065f46",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
                
                // Prompt Print
                window.print();
            }, 300);
        }

        // --- EXCEL/CSV DOWNLOAD (Landscape Class Sheet) ---
        function downloadClassPerformance() {
             const cls = document.getElementById('report-class').value;
             const term = document.getElementById('report-term').value;
             if(!cls || !term) return showModal('Missing Selection', "Please select both Class and Term to download the performance sheet.", 'warning');

             // 1. Calculate and sort all students for the class/term
             const students = db.students.filter(s => s.class === cls);
             const scores = students.map(s => {
                 const res = calculateResults(s.id, cls, term);
                 const position = getPosition(s.id, cls, term); // Recalculate position
                 return { ...s, ...res, position };
             }).sort((a, b) => parseFloat(b.average) - parseFloat(a.average)); // Sort by average descending

             if (scores.length === 0) return showModal('No Data', 'No students or marks found for this Class/Term combination.', 'warning');
             
             // 2. Prepare Headers (Dynamic Subjects)
             let csvContent = "data:text/csv;charset=utf-8,";
             let subjectHeaders = db.subjects.map(s => `(${s}) Total,(${s}) Grade`).join(',');
             let headers = `Student Name,Class,Term,Overall Average,Class Position,Total Score,${subjectHeaders}\n`;
             csvContent += headers;

             // 3. Prepare Rows
             scores.forEach(s => {
                 let row = `"${s.name}","${s.class}","${term}","${s.average}%","${s.position}","${s.totalScore}"`;
                 
                 // Add subject scores
                 db.subjects.forEach(sub => {
                     const subjectResult = s.results.find(r => r.subject === sub);
                     if (subjectResult) {
                         row += `,"${subjectResult.total}","${subjectResult.grade}"`;
                     } else {
                         row += `,"-","-"`; // Placeholder for missing marks
                     }
                 });
                 csvContent += row + "\n";
             });

             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `${cls}_${term}_Performance_Sheet.csv`);
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             showModal('Download Complete', 'The performance sheet has been downloaded in CSV (Excel) format.', 'success');
        }

        function reprintAllReports() {
            showModal('Functionality Note', "For batch printing, please print students individually using the 'View Card' button to ensure accurate Report Card layout and QR Code generation for each A4 page.", 'info');
        }


        // --- FINANCE (RECEIPT) ---
        function generateReceipt() {
            const studentId = document.getElementById('receipt-student').value;
            const amount = document.getElementById('fee-amount').value;
            const purpose = document.getElementById('fee-purpose').value;
            
            if(!studentId || !amount || !purpose) return showModal('Missing Details', "Please select a student, amount, and purpose to generate the receipt.", 'warning');
            
            const student = db.students.find(s => s.id === studentId);
            const date = new Date().toLocaleDateString();
            const ref = "NB" + Date.now().toString().slice(-6);
            
            // 1. CLEAR REPORT CARD AREA
            document.getElementById('printable-area').innerHTML = '';
            
            // 2. TARGET RECEIPT PREVIEW AREA
            const receiptArea = document.getElementById('receipt-preview-area');
            
            // Receipt HTML - Beautiful and Unique Design
            receiptArea.innerHTML = `
                <div class="receipt-paper a4-paper !w-[100mm] !min-h-[140mm] !shadow-none !border-2 !border-dashed !border-blue-400 bg-blue-50">
                     <div class="text-center border-b-2 border-dashed border-blue-400 pb-3 mb-4">
                        <i class="fas fa-wallet text-3xl text-blue-700 mb-1"></i>
                        <h2 class="text-xl font-bold uppercase text-blue-800">Nurul Bayan Science Academy</h2>
                        <p class="text-sm text-gray-600">Official Payment Receipt</p>
                        <p class="text-xs text-blue-500 mt-1">Ref No: ${ref} | Date: ${date}</p>
                     </div>
                     
                     <div class="space-y-3 text-sm font-semibold">
                        <div class="flex justify-between border-b border-gray-200 pb-1">
                            <span class="text-gray-600">Received From:</span>
                            <span class="font-bold text-gray-800">${student.name}</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-200 pb-1">
                            <span class="text-gray-600">Class:</span>
                            <span>${student.class}</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-200 pb-1">
                            <span class="text-gray-600">Payment Purpose:</span>
                            <span>${purpose}</span>
                        </div>
                        <div class="flex justify-between border-t-2 border-b-2 border-blue-700 py-2 my-2">
                            <span class="font-bold text-lg text-blue-900">AMOUNT:</span>
                            <span class="font-bold text-lg text-blue-900">₦${Number(amount).toLocaleString()}</span>
                        </div>
                     </div>
                     
                     <div class="mt-6 text-center text-xs">
                        <div class="border-b border-gray-400 w-24 mx-auto mb-1"></div>
                        <p>Bursar / Manager Signature</p>
                        <p class="mt-4 text-xs italic text-blue-400">Thank you for your prompt payment.</p>
                     </div>
                    <div class="absolute bottom-1 left-0 w-full text-center text-[8px] text-gray-500">
                        Generated by Nurul Bayan Portal | Dev: Abu-Abdurrahman CodeVerge | +2348107907647
                    </div>
                </div>
            `;
            
            window.print();
            
            // Save transaction
            db.fees.push({ ref, studentId, amount, purpose, date });
            saveData();
            showModal('Receipt Generated', 'The receipt is ready for printing.', 'success');
        }


        // --- GLOBAL MODAL (Replaces Alert/Confirm) ---
        function showModal(title, message, type = 'info') {
            let icon, color;
            switch (type) {
                case 'success': icon = 'fas fa-check-circle'; color = 'text-green-500'; break;
                case 'warning': icon = 'fas fa-exclamation-triangle'; color = 'text-yellow-500'; break;
                case 'danger': icon = 'fas fa-times-circle'; color = 'text-red-500'; break;
                default: icon = 'fas fa-info-circle'; color = 'text-blue-500';
            }

            const existingModal = document.getElementById('custom-modal-overlay');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="custom-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-80 text-center transform transition-all duration-300 scale-100">
                        <i class="${icon} ${color} text-4xl mb-3"></i>
                        <h3 class="text-xl font-bold mb-2 text-gray-800">${title}</h3>
                        <p class="text-sm text-gray-600 mb-4">${message}</p>
                        <button onclick="document.getElementById('custom-modal-overlay').remove()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Confirmation Modal for critical actions (like delete)
        let pendingAction = null;
        let pendingArgs = null;

        function confirmAction(action, args, title, message) {
            pendingAction = action;
            pendingArgs = args;

            const existingModal = document.getElementById('custom-modal-overlay');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="custom-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-96 text-center transform transition-all duration-300 scale-100">
                        <i class="fas fa-exclamation-triangle text-orange-500 text-4xl mb-3"></i>
                        <h3 class="text-xl font-bold mb-2 text-gray-800">${title}</h3>
                        <p class="text-sm text-gray-600 mb-6">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button onclick="document.getElementById('custom-modal-overlay').remove()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">Cancel</button>
                            <button onclick="executePendingAction()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition text-sm">Confirm & Proceed</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function executePendingAction() {
            document.getElementById('custom-modal-overlay').remove();
            if (pendingAction && window[pendingAction]) {
                window[pendingAction](pendingArgs);
            }
            pendingAction = null;
            pendingArgs = null;
        }

    </script>
</body>
</html>
